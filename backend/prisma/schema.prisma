// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Council {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  country     String   @default("NZ")
  region      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  permitTypes PermitType[]
  applications Application[]

  @@map("councils")
}

model PermitType {
  id          String   @id @default(cuid())
  name        String
  code        String
  description String?
  requirements Json?    // Flexible requirements structure
  fees        Json?     // Fee structure
  councilId   String
  isActive    Boolean   @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  council     Council @relation(fields: [councilId], references: [id], onDelete: Cascade)
  applications Application[]

  @@unique([councilId, code])
  @@map("permit_types")
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  permissions Json?    // Array of permission strings
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users User[]

  @@map("roles")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String   // Hashed password
  firstName String
  lastName  String
  phone     String?
  address   Json?    // Structured address data
  isActive  Boolean  @default(true)
  emailVerified Boolean @default(false)
  roleId    String
  lastLoginAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  applications Application[]
  role       Role @relation(fields: [roleId], references: [id])
  sessions   UserSession[]
  passwordResets PasswordReset[]

  @@map("users")
}

model UserSession {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique // JWT refresh token
  expiresAt DateTime
  createdAt DateTime @default(now())

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

model Application {
  id          String   @id @default(cuid())
  reference   String   @unique
  status      ApplicationStatus @default(SUBMITTED)
  userId      String
  councilId   String
  permitTypeId String
  data        Json     // Form data
  documents   Json?    // Document references
  aiAnalysis  Json?    // AI analysis results
  submittedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  processedAt DateTime?

  // Relations
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  council     Council @relation(fields: [councilId], references: [id], onDelete: Cascade)
  permitType  PermitType @relation(fields: [permitTypeId], references: [id], onDelete: Cascade)

  @@map("applications")
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  CANCELLED
} 